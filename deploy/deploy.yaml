---
- hosts: do
  remote_user: root
  vars:
    ansible_python_interpreter: /usr/bin/python3
    project_root: /project
  #   wtd_srv_docker_compose_package_state: latest
  #   ## Service Management
  #   wtd_srv_docker_service: "docker"
  #   # State can be started|stopped
  #   wtd_srv_docker_service_state: "started"
  #   wtd_srv_docker_service_enabled: true

  # roles:
  #   - while_true_do.srv_docker
  tasks:

    - name: Disable SELinux
      selinux:
        state: disabled

    - name: Ensure base requirements are installed
      package:
        name:
          - git
          - postgresql
          - nginx
          - dnf-plugins-core
        state: present
      retries: 5
      register: result
      until: result is succeeded

    # TODO: trocar pelo modulo correto
    - name: Add docker-ce repo
      command: dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo

    - name: Install docker
      package:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io

    - name: Install Pip requirements
      pip:
        name: 
          - docker-compose

    - name: Start service docker, if not started
      service:
        name: docker
        state: started

    - name: Git Repo
      git:
        repo: https://github.com/flask-extensions/flaskextensions.com
        dest: "{{ project_root }}"

    - name: Set variables on .variables.env (ansible vault)
      copy:
        src: ../.variables.env
        dest: "{{ project_root }}/.variables.env"
    
    - name: Tear down existing services
      docker_compose:
        project_src: "{{ project_root }}"
        state: absent

    - name: Create and start services
      docker_compose:
        project_src: "{{ project_root }}"
        build: yes
      register: output

    - debug:
        var: output

    - name:  Setup NGINX
      debug: 
        msg: "setup nginx"
